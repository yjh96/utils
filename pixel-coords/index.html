<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>í”½ì…€ ì¢Œí‘œê³„ ë„ë©´ ë„êµ¬ (ë§ˆì»¤ í¬ê¸° í™•ëŒ€ + ë²ˆí˜¸)</title>
        <style>
            body {
                font-family: sans-serif;
                text-align: center;
                padding: 1em;
            }
            canvas {
                border: 1px solid #333;
                max-width: 100%;
                height: auto;
                display: block;
                margin: auto;
            }
            #coordDisplay,
            #historyBox {
                margin-top: 1em;
                font-size: 1.1em;
            }
            #inputBox,
            #buttonBox {
                margin-top: 1em;
            }
            input[type="number"] {
                width: 100px;
                padding: 5px;
                margin: 0 5px;
            }
            button {
                padding: 5px 10px;
                margin: 5px;
            }
            #historyList {
                width: 90%;
                margin: auto;
                max-width: 800px;
                margin-top: 1em;
                border-collapse: collapse;
            }
            #historyList th,
            #historyList td {
                border: 1px solid #ccc;
                padding: 6px 10px;
            }
            #historyList th {
                background-color: #eee;
            }
        </style>
    </head>
    <body>
        <h2>ë„ë©´ í”½ì…€ ì¢Œí‘œ í´ë¦­ ë„êµ¬ (Leaflet-style + í° ë§ˆì»¤)</h2>
        <input type="file" id="imgInput" accept="image/*" /><br />
        <canvas id="canvas"></canvas>

        <div id="coordDisplay">ì¢Œí‘œ: ì—†ìŒ</div>

        <div id="inputBox">
            <label>longitude (X): <input type="number" id="inputX" /></label>
            <label>latitude (Y): <input type="number" id="inputY" /></label>
            <button onclick="markInput()">í‘œì‹œ</button>
        </div>

        <div id="buttonBox">
            <button onclick="clearMarkers()">ğŸ§¹ ë§ˆì»¤ ì§€ìš°ê¸°</button>
            <button onclick="clearHistory()">ğŸ—‘ï¸ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”</button>
        </div>

        <div id="historyBox">
            <h3>ğŸ“‹ ì¢Œí‘œ íˆìŠ¤í† ë¦¬</h3>
            <table id="historyList">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>longitude (X)</th>
                        <th>latitude (Y)</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>

        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const imgInput = document.getElementById("imgInput");
            const coordDisplay = document.getElementById("coordDisplay");
            const inputX = document.getElementById("inputX");
            const inputY = document.getElementById("inputY");
            const historyBody = document.getElementById("historyBody");

            let img = new Image();
            let scale = 1;
            let clickCount = 0;
            let markerList = [];

            imgInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (event) {
                    img.onload = function () {
                        const maxWidth = 1600;
                        scale = Math.min(1, maxWidth / img.width);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;

                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        drawAllMarkers();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });

            canvas.addEventListener("click", (e) => {
                if (!img.complete) return;

                const rect = canvas.getBoundingClientRect();
                const x = Math.round(
                    (e.clientX - rect.left) *
                        (img.naturalWidth / canvas.clientWidth)
                );
                const y = Math.round(
                    (e.clientY - rect.top) *
                        (img.naturalHeight / canvas.clientHeight)
                );

                const longitude = x;
                const latitude = yFlip(y);

                coordDisplay.innerText = `Clicked: longitude = ${longitude}, latitude = ${latitude}`;
                addHistory(longitude, latitude);
            });

            function markInput() {
                const longitude = parseInt(inputX.value);
                const latitude = parseInt(inputY.value);
                if (isNaN(longitude) || isNaN(latitude)) return;
                addHistory(longitude, latitude);
            }

            function drawAllMarkers() {
                if (!img.complete) return;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                for (let i = 0; i < markerList.length; i++) {
                    const marker = markerList[i];
                    const x = marker.longitude;
                    const y = yFlipInverse(marker.latitude);

                    ctx.strokeStyle = "red";
                    ctx.lineWidth = 100;
                    ctx.strokeRect(x - 5, y - 5, 10, 10); // Bigger marker

                    ctx.fillStyle = "red";
                    ctx.font = "bold 16px sans-serif";
                    ctx.fillText(`${i + 1}`, x + 12, y - 6);
                }
            }

            function yFlip(y) {
                return img.height - y;
            }

            function yFlipInverse(lat) {
                return img.height - lat;
            }

            function addHistory(longitude, latitude) {
                clickCount++;
                markerList.push({ longitude, latitude });
                drawAllMarkers();

                const row = document.createElement("tr");
                row.innerHTML = `<td>${clickCount}</td><td>${longitude}</td><td>${latitude}</td>`;
                if (historyBody.firstChild) {
                    historyBody.insertBefore(row, historyBody.firstChild);
                } else {
                    historyBody.appendChild(row);
                }
            }

            function clearMarkers() {
                markerList = [];
                drawAllMarkers();
            }

            function clearHistory() {
                clickCount = 0;
                historyBody.innerHTML = "";
                clearMarkers();
                coordDisplay.innerText = "ì¢Œí‘œ: ì—†ìŒ";
            }
        </script>
    </body>
</html>
